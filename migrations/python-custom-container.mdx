---
title: "Python Custom Container"
description: "Migrate Python MCP servers to HTTP using custom Docker containers with FastMCP"
---

# Python Custom Container

This guide covers migrating Python MCP servers to HTTP using custom Docker containers with FastMCP from the official MCP SDK.

## When to Use This Approach

Choose Python custom containers when you:
- Use Python for your MCP server
- Need full control over your Docker environment
- Want to use FastMCP with custom middleware
- Have specific Python dependencies or requirements

## What We're Building

We'll build a simple stateless MCP server with a `greet` tool that:
- Takes a user's name and returns a greeting
- Validates an API key from Smithery configuration
- Shows proper CORS handling and middleware setup

<Note>
**Full Implementation**: For complete working examples with all dependencies and configuration files, check our [example repositories](https://github.com/smithery-ai/mcp-examples) on GitHub.
</Note>

## Code Migration

<CodeGroup>

```python Before (STDIO)
from mcp.server.fastmcp import FastMCP

# Create STDIO server
mcp = FastMCP("example-server")

@mcp.tool()
def greet(name: str = "World") -> str:
    """Greet someone by name."""
    return f"Hello, {name}!"

# Run with STDIO transport
if __name__ == "__main__":
    mcp.run(transport="stdio")
```

```python After (HTTP Container)
import os
import uvicorn
import json
import base64
from urllib.parse import parse_qs, unquote
from mcp.server.fastmcp import FastMCP
from starlette.middleware.cors import CORSMiddleware
from typing import Optional

# Initialize MCP server
mcp = FastMCP(name="example-server")

# Store API key from Smithery config
current_api_key: Optional[str] = None

def validate_api_key(api_key: Optional[str]) -> bool:
    """Validate API key - accepts any non-empty string for demo."""
    if not api_key:
        return False
    return len(api_key.strip()) > 0

@mcp.tool
def greet(name: str = "World") -> str:
    """Greet someone by name."""
    if not validate_api_key(current_api_key):
        raise ValueError("API key required! Please configure an API key in Smithery.")
    
    return f"Hello, {name}! (authenticated with {current_api_key[:8]}...)"

# Extract API key from Smithery's base64-encoded config parameter
class SmitheryConfigMiddleware:
    def __init__(self, app):
        self.app = app

    async def __call__(self, scope, receive, send):
        global current_api_key
        
        if scope.get('type') == 'http' and scope.get('path') in ['/mcp', '/mcp/']:
            query_string = scope.get('query_string', b'').decode('utf-8')
            if query_string:
                params = parse_qs(query_string)
                if 'config' in params:
                    try:
                        # URL decode then base64 decode config from Smithery
                        config_b64 = unquote(params['config'][0])
                        config_json = base64.b64decode(config_b64).decode('utf-8')
                        config = json.loads(config_json)
                        
                        # Extract API key matching smithery.yaml schema
                        if 'apiKey' in config:
                            current_api_key = config['apiKey']
                    except (json.JSONDecodeError, Exception, IndexError, KeyError):
                        current_api_key = None
        
        await self.app(scope, receive, send)

# Handle /mcp path routing for MCP protocol
class MCPPathRedirect:
    def __init__(self, app):
        self.app = app

    async def __call__(self, scope, receive, send):
        if scope.get('type') == 'http' and scope.get('path') == '/mcp':
            scope['path'] = '/mcp/'
            scope['raw_path'] = b'/mcp/'
        await self.app(scope, receive, send)

if __name__ == "__main__":
    # Setup Starlette app with CORS for cross-origin requests
    app = mcp.streamable_http_app()
    
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],  # Configure more restrictively in production
        allow_credentials=True,
        allow_methods=["GET", "POST", "OPTIONS"],
        allow_headers=["*"],
        expose_headers=["mcp-session-id"],  # Critical for MCP session management
        max_age=86400,
    )

    # Apply custom middleware stack
    app = SmitheryConfigMiddleware(app)
    app = MCPPathRedirect(app)

    # Use PORT environment variable (required by Smithery)
    port = int(os.environ.get("PORT", 8000))

    uvicorn.run(app, host="0.0.0.0", port=port, log_level="info")
```

</CodeGroup>

<Note>
**Configuration is Optional**: If your MCP server doesn't need any configuration (API keys, settings, etc.), you can remove all the config parsing middleware and validation code. The server will work perfectly fine without it.
</Note>

<Note>
**Full Implementation**: For complete working examples with all dependencies and configuration files, check our [example repositories](https://github.com/smithery-ai/mcp-examples) on GitHub.
</Note>

## Configuration Changes

### Update smithery.yaml

<CodeGroup>

```yaml Before (STDIO)
startCommand:
  type: stdio
  commandFunction: |
    (config) => ({
      command: 'python',
      args: ['server.py'],
      env: {
        API_KEY: config.apiKey
      }
    })
  configSchema:
    type: object
    required: [apiKey]
    properties:
      apiKey:
        type: string
        description: Your API key
  exampleConfig:
    apiKey: "sk-example-123"
```

```yaml After (HTTP Container)
runtime: "container"
build:
  dockerfile: "Dockerfile"           # Path to your Dockerfile
  dockerBuildPath: "."               # Docker build context
startCommand:
  type: "http"
  configSchema:                      # Optional: Define configuration schema
    type: object
    required: [apiKey]
    properties:
      apiKey:
        type: string
        description: Your API key
  exampleConfig:                     # Optional: Example configuration
    apiKey: "sk-example-123"
```

</CodeGroup>

### Update Dockerfile

<CodeGroup>

```dockerfile Before (STDIO)
FROM python:3.11-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .

# STDIO servers don't expose ports
CMD ["python", "server.py"]
```

```dockerfile After (HTTP Container)
FROM python:3.11-slim

WORKDIR /app

# Install dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY . .

# HTTP servers must expose the port
EXPOSE 8000
CMD ["python", "server.py"]
```

</CodeGroup>



## Local Testing

```bash
# Build and run locally
docker build -t my-mcp-server .
docker run -p 8000:8000 -e PORT=8000 my-mcp-server

# Test MCP endpoint
curl -X POST http://localhost:8000/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}'
```

### Configuration Testing

Test with base64 encoded configuration:

```bash
# Create test config
echo '{"apiKey":"test-key"}' | base64

# Test with config parameter
curl -X POST "http://localhost:8000/mcp?config=eyJhcGlLZXkiOiJ0ZXN0LWtleSJ9Cg==" \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","id":1,"method":"tools/list","params":{}}'
```

## Deployment

1. **Push Code**: Push your updated code (including `Dockerfile` and `smithery.yaml`) to GitHub
2. **Deploy**: Go to [smithery.ai/new](https://smithery.ai/new) and connect your GitHub repository
3. **Verify**: Test your deployed server through the Smithery interface

Smithery will automatically build your container and host your MCP server, making it available to over 10,000 users.

## Key Changes Summary

1. **FastMCP HTTP**: Use `mcp.streamable_http_app()` to get Starlette app
2. **Custom Middleware**: Implement config parsing and path redirect middleware
3. **CORS Configuration**: Enable browser-based MCP clients with proper headers
4. **Configuration Parsing**: Parse base64 encoded config from query parameters
5. **Container Runtime**: Set `runtime: "container"` in `smithery.yaml`
6. **Uvicorn Server**: Use production ASGI server for deployment

---

**Need help?** Join our [Discord](https://discord.gg/Afd38S5p9A) or email [support@smithery.ai](mailto:support@smithery.ai) for assistance.
